name: Test Docker Image

on:
  workflow_run:
    workflows: ["Build and Publish Docker Image"]
    types:
      - completed

  workflow_dispatch:
    inputs:
      tag:
        description: "Docker Image tag as generated by the build action, preceded by ':' (e.g. ':latest')"
        required: true
        default: ":latest"

jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/lobis/root-geant4-garfield${{ github.event.inputs.tag }}

    steps:
      - name: Print environment variables
        run: |
          echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH"
          echo "ROOTSYS: $ROOTSYS"
          echo "ROOT_INCLUDE_PATH: $ROOT_INCLUDE_PATH"
          printenv

      - name: Check ROOT is available in non-interactive shell
        run: |
          root-config --version
          root-config --prefix
          root-config --cflags

      - name: Check Geant4 is available in non-interactive shell
        run: |
          geant4-config --version
          geant4-config --prefix
          geant4-config --cflags
          geant4-config --datasets

      - name: Check ROOT
        run: |
          root -e 'TTree tree; return 0;' -q

      - name: Check Geant4 by building and runing a basic example
        run: |
          G4_VERSION=$(geant4-config --version)
          G4_INSTALL=$(geant4-config --prefix)
          G4_EXAMPLES=${G4_INSTALL}/share/Geant4-${G4_VERSION}/examples
          echo "Geant4 examples dir: $G4_EXAMPLES"
          cd $G4_EXAMPLES/basic/B1
          mkdir build && cd build
          cmake ..
          make
          ./exampleB1 run1.mac

      - name: Check Garfield is available from ROOT prompt
        run: |
          root -e '
          #include "Garfield/MediumMagboltz.hh"
          using namespace Garfield;
          MediumMagboltz gas;
          return 0;' -q
